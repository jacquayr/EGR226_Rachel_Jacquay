/*-----------------------------------------------------------------------------------------
 * Author:          Rachel Jacquay
 * Course:          EGR 226-902
 * Date:            03/17/2021
 * Project:         Lab 8 Part 3
 * File:            main_part3.c
 * Description:     This program uses Timer A, an Octocoupler, and the keypad to create
 *                  a pseudo PWM analog voltage for the DC motor. The speed of the motor
 *                  was changed by the input of the keypad, which then changed the duty
 *                  cycle of Timer A, which then made the motor slow down or speed up.
-----------------------------------------------------------------------------------------*/

// libraries
#include "msp.h"
#include "SysTick.h"
#include <stdio.h>
#include <stdlib.h>

// function prototypes
void pin_init(void);
void T32_INT2_IRQHandler(void);
void ADCsetup(void);

void main(void)
{
    __disable_irq();
    WDT_A->CTL = WDT_A_CTL_PW | WDT_A_CTL_HOLD;     // stop watchdog timer
    pin_init();                                     // initializations
    SysTick_Init();
    ADCsetup();
    TIMER32_2->CONTROL = 0b11100011; //Sets timer 2 for Enabled, Periodic, With Interrupt, No Prescaler, 32 bit mode, One Shot Mode. See 589 / reference manual

    NVIC_EnableIRQ (T32_INT1_IRQn);                 // NVIC call for backlight
    __enable_irq();

    TIMER32_2->LOAD = 1500;

    while(1) {

    }
}

/*--------------------------------------------------------------
 * Function:        pin_init
 *
 * Description:     This function initializes the pins on the
 *                  MSP432 that are connected to the DC motor
 *                  and the keypad.
 *
 * Inputs:          none
 *
 * Outputs:         none
 *-------------------------------------------------------------*/
void pin_init(void) {
    P2->SEL0 |= BIT7;   // configure P2.4 for PWM
    P2->SEL1 &= ~BIT7;
    P2->DIR |= BIT7;

    TIMER_A0->CCR[0] |= period;                     // set period amount
    TIMER_A0->CCTL[4] |= TIMER_A_CCTLN_OUTMOD_7;    // set to outmode 7
    TIMER_A0->CCR[4] = DC;                          // set duty cycle
    TIMER_A0->CTL |= 0x0214;                        // set to SMCLK, up mode, clear TAR to start

    P4->SEL0 &= ~0x7F;      // enable simple I/O
    P4->SEL1 &= ~0x7F;
    P4->DIR &= ~0x7F;       // set as input
    P4->REN |= 0x0F;        // enable resistor
    P4->OUT |= 0x0F;        // enable pull up resistor
}

/*--------------------------------------------------------------
 * Function:        ADCsetup
 *
 * Description:     This function sets up the pin 5.5 for ADC
 *                  and also sets up the ADC in the MSP432 for
 *                  use.
 *
 * Inputs:          none
 *
 * Outputs:         none
 *-------------------------------------------------------------*/
void ADCsetup(void) {
    ADC14->CTL0 = 0x00000010;       // power on & disabled during config
    ADC14->CTL0 |= 0x04D80300;      // S/H pulse mode, MCLK, 32 sample clocks, SW trigger, /4 clock divide

    ADC14->CTL1 = 0x00000030;       // 14-bit resolution
    ADC14->MCTL[5] = 0;             // A0 input, single ended, vref = avcc

    P8->SEL1 |= BIT4;               // configure P5.5 for AO
    P8->SEL0 |= BIT4;

    ADC14->CTL1 |= 0x00050000;      // start converting at mem reg 5
    ADC14->CTL0 |= 2;               // enable ADC after config
}
